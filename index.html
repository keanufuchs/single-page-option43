<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Cisco DHCP Option 43 Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;600;700&family=IBM+Plex+Mono:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        color-scheme: only light;
      }
      body {
        font-family: "IBM Plex Sans", "Segoe UI", system-ui, sans-serif;
      }
      .sketch-title {
        font-family: "IBM Plex Sans", "Segoe UI", system-ui, sans-serif;
        letter-spacing: 0.01em;
      }
      .sketch-card {
        border-radius: 12px;
        border: 1px solid #e2e8f0;
        background: #ffffff;
        box-shadow: 0 8px 24px rgba(15, 23, 42, 0.08);
      }
      .sketch-input {
        border-radius: 8px;
        border: 1px solid #cbd5f5;
        background: #ffffff;
      }
      .sketch-input:disabled {
        background: #f1f5f9;
        color: #64748b;
        cursor: not-allowed;
      }
      .sketch-button {
        border-radius: 8px;
        border: 1px solid #0f172a;
      }
      .noise {
        background: linear-gradient(180deg, #f8fafc 0%, #eef2f6 100%);
      }
      .byte-pill {
        border: 1px solid #0f172a;
        border-radius: 999px;
        padding: 6px 12px;
        background: #e2e8f0;
        font-weight: 600;
        font-family: "IBM Plex Mono", ui-monospace, SFMono-Regular, Menlo, Monaco,
          Consolas, "Liberation Mono", "Courier New", monospace;
      }
      .tooltip {
        position: relative;
      }
      .tooltip:after {
        content: attr(data-tip);
        position: absolute;
        left: 50%;
        bottom: calc(100% + 10px);
        transform: translateX(-50%);
        white-space: nowrap;
        background: #1f2937;
        color: #fff;
        padding: 6px 10px;
        border-radius: 8px;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s ease;
        font-size: 12px;
      }
      .tooltip:hover:after {
        opacity: 1;
      }
      .warning {
        border: 2px dashed #b91c1c;
        background: #fee2e2;
      }
    </style>
  </head>
  <body class="min-h-screen bg-[#f7f1e5] text-slate-900 noise">
      <div class="max-w-6xl mx-auto px-6 py-10">
      <header class="sketch-card px-8 py-8 mb-10">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6">
          <div>
            <h1 class="sketch-title text-4xl sm:text-5xl font-bold">
              Cisco DHCP Option 43 Builder
            </h1>
            <p class="mt-3 text-lg max-w-2xl">
              Generate Option 43 hex for classic WLC discovery (F1) or Fast
              Offline Migration (F3), then export clean IOS / IOS-XE pool
              configs with byte-by-byte clarity.
            </p>
          </div>
          <div class="text-sm bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 shadow-sm">
            <p class="font-semibold">Format summary</p>
            <p>F1: `F1 &lt;len&gt; &lt;WLCs&gt;`</p>
            <p>F3: `F3 &lt;len&gt; &lt;WLCs&gt; &lt;mode&gt;`</p>
            <p class="text-xs mt-1">Hover each byte for context.</p>
          </div>
        </div>
      </header>

      <div class="grid lg:grid-cols-[2fr_1fr] gap-8">
        <section class="sketch-card px-6 py-6 space-y-6">
          <div>
            <h2 class="sketch-title text-3xl font-semibold">Mode & Output</h2>
            <div class="mt-4 grid gap-4 sm:grid-cols-2">
              <label class="block">
                <span class="text-sm font-semibold">DHCP Mode</span>
                <select id="mode" class="sketch-input mt-2 w-full px-3 py-2">
                  <option value="F1">Classic Option 43 (F1)</option>
                  <option value="F3">Fast Offline Migration (F3)</option>
                </select>
              </label>
              <label class="block">
                <span class="text-sm font-semibold">AP Mode (F3 only)</span>
                <select id="apMode" class="sketch-input mt-2 w-full px-3 py-2">
                  <option value="">Select mode</option>
                  <option value="01">Meraki (01)</option>
                  <option value="02">Catalyst (02)</option>
                </select>
              </label>
              <label class="block">
                <span class="text-sm font-semibold">Pool Name</span>
                <input
                  id="poolName"
                  class="sketch-input mt-2 w-full px-3 py-2"
                  placeholder="WIFI_APS"
                />
              </label>
              <label class="block sm:col-span-2">
                <span class="text-sm font-semibold">Reverse Decode (Option 43 Hex)</span>
                <input
                  id="reverseHex"
                  class="sketch-input mt-2 w-full px-3 py-2 font-mono"
                  placeholder="f3050a010b1f02"
                />
                <p class="text-xs mt-1 text-slate-600">
                  Paste full hex (with or without dots/spaces) to populate fields.
                </p>
              </label>
            </div>
          </div>

          <div>
            <h2 class="sketch-title text-3xl font-semibold">Network Inputs</h2>
            <div class="mt-4 grid gap-4 sm:grid-cols-2">
              <label class="block sm:col-span-2">
                <span class="text-sm font-semibold">Management VLAN Subnet (CIDR)</span>
                <input
                  id="cidr"
                  class="sketch-input mt-2 w-full px-3 py-2"
                  placeholder="10.10.40.0/24"
                />
                <p class="text-xs mt-1 text-slate-600">Required for IOS config output.</p>
              </label>
              <label class="block">
                <span class="text-sm font-semibold">Default Gateway</span>
                <input
                  id="gateway"
                  class="sketch-input mt-2 w-full px-3 py-2"
                  placeholder="10.10.40.1"
                />
              </label>
              <label class="block">
                <span class="text-sm font-semibold">DNS Servers</span>
                <input
                  id="dns"
                  class="sketch-input mt-2 w-full px-3 py-2"
                  placeholder="8.8.8.8, 1.1.1.1"
                />
              </label>
              <label class="block">
                <span class="text-sm font-semibold">Domain Name</span>
                <input
                  id="domain"
                  class="sketch-input mt-2 w-full px-3 py-2"
                  placeholder="lab.example"
                />
              </label>
              <div class="grid grid-cols-3 gap-3 sm:col-span-2">
                <label class="block">
                  <span class="text-sm font-semibold">Lease Days</span>
                  <input
                    id="leaseDays"
                    class="sketch-input mt-2 w-full px-3 py-2"
                    placeholder="7"
                    type="number"
                    min="0"
                  />
                </label>
                <label class="block">
                  <span class="text-sm font-semibold">Lease Hours</span>
                  <input
                    id="leaseHours"
                    class="sketch-input mt-2 w-full px-3 py-2"
                    placeholder="0"
                    type="number"
                    min="0"
                    max="23"
                  />
                </label>
                <label class="block">
                  <span class="text-sm font-semibold">Lease Minutes</span>
                  <input
                    id="leaseMinutes"
                    class="sketch-input mt-2 w-full px-3 py-2"
                    placeholder="0"
                    type="number"
                    min="0"
                    max="59"
                  />
                </label>
              </div>
            </div>
          </div>

          <div>
            <h2 class="sketch-title text-3xl font-semibold">WLC Input</h2>
            <p class="mt-2 text-xs text-slate-600">
              Single WLC address; encoded as 4 bytes.
            </p>
            <div id="wlcList" class="mt-4 grid gap-3"></div>
          </div>
        </section>

        <aside class="space-y-6">
          <section class="sketch-card px-6 py-6">
            <h3 class="sketch-title text-2xl font-semibold">Hex Breakdown</h3>
            <div class="mt-4 flex flex-wrap gap-3" id="hexBreakdown"></div>
            <div id="hexWarnings" class="mt-4 text-sm"></div>
          </section>

          <section class="sketch-card px-6 py-6">
            <h3 class="sketch-title text-2xl font-semibold">Output</h3>
            <div class="mt-4 space-y-4">
              <div>
                <div class="flex items-center justify-between">
                  <span class="text-sm font-semibold">Hex (plain)</span>
                  <button
                    class="sketch-button px-3 py-1 bg-slate-900 text-white"
                    data-copy="hexPlain"
                  >
                    Copy
                  </button>
                </div>
                <div
                  id="hexPlain"
                  class="mt-2 sketch-input px-3 py-2 text-sm break-all"
                ></div>
              </div>
              <div>
                <div class="flex items-center justify-between">
                  <span class="text-sm font-semibold">Hex (dotted)</span>
                  <button
                    class="sketch-button px-3 py-1 bg-slate-900 text-white"
                    data-copy="hexDotted"
                  >
                    Copy
                  </button>
                </div>
                <div
                  id="hexDotted"
                  class="mt-2 sketch-input px-3 py-2 text-sm break-all"
                ></div>
              </div>
              <div id="configSection">
                <div class="flex items-center justify-between">
                  <span class="text-sm font-semibold">Cisco IOS Config</span>
                  <button
                    class="sketch-button px-3 py-1 bg-slate-900 text-white"
                    data-copy="iosConfig"
                  >
                    Copy
                  </button>
                </div>
                <pre
                  id="iosConfig"
                  class="mt-2 sketch-input px-3 py-2 text-xs whitespace-pre-wrap"
                ></pre>
              </div>
            </div>
          </section>
        </aside>
      </div>

      <section class="sketch-card px-6 py-6 mt-10">
        <h3 class="sketch-title text-2xl font-semibold">Hex Composition Rules</h3>
        <div class="mt-3 grid gap-4 sm:grid-cols-2 text-sm">
          <div>
            <p class="font-semibold">Classic Option 43 (F1)</p>
            <p>Format: `F1 &lt;length&gt; &lt;WLC-IP-ARRAY&gt;`</p>
            <p>Length = number of WLCs × 4 bytes</p>
            <p>Example: `f1040a010b1f`</p>
          </div>
          <div>
            <p class="font-semibold">Fast Offline Migration (F3)</p>
            <p>Format: `F3 &lt;length&gt; &lt;WLC-IP-ARRAY&gt; &lt;MODE&gt;`</p>
            <p>Length = (WLCs × 4) + 1 mode byte</p>
            <p>Example: `f3050a010b1f02`</p>
          </div>
        </div>
      </section>
    </div>

    <script>
      const modeEl = document.getElementById("mode");
      const apModeEl = document.getElementById("apMode");
      const wlcListEl = document.getElementById("wlcList");
      const hexBreakdownEl = document.getElementById("hexBreakdown");
      const hexWarningsEl = document.getElementById("hexWarnings");
      const hexPlainEl = document.getElementById("hexPlain");
      const hexDottedEl = document.getElementById("hexDotted");
      const iosConfigEl = document.getElementById("iosConfig");

      const inputs = {
        cidr: document.getElementById("cidr"),
        gateway: document.getElementById("gateway"),
        dns: document.getElementById("dns"),
        domain: document.getElementById("domain"),
        leaseDays: document.getElementById("leaseDays"),
        leaseHours: document.getElementById("leaseHours"),
        leaseMinutes: document.getElementById("leaseMinutes"),
        poolName: document.getElementById("poolName"),
        reverseHex: document.getElementById("reverseHex"),
      };

      function isValidIp(ip) {
        const parts = ip.trim().split(".");
        if (parts.length !== 4) return false;
        return parts.every((part) => {
          if (!/^\d{1,3}$/.test(part)) return false;
          const n = Number(part);
          return n >= 0 && n <= 255;
        });
      }

      function ipToHex(ip) {
        return ip
          .trim()
          .split(".")
          .map((oct) => Number(oct).toString(16).padStart(2, "0"))
          .join("");
      }

      function cidrToMask(cidr) {
        const bits = Number(cidr);
        if (Number.isNaN(bits) || bits < 0 || bits > 32) return "";
        const mask = [0, 0, 0, 0];
        let remaining = bits;
        for (let i = 0; i < 4; i += 1) {
          const take = Math.min(8, remaining);
          mask[i] = take === 0 ? 0 : 256 - Math.pow(2, 8 - take);
          remaining -= take;
        }
        return mask.join(".");
      }

      function parseCidr(value) {
        const [network, bits] = value.split("/");
        if (!network || bits === undefined) return null;
        if (!isValidIp(network)) return null;
        const mask = cidrToMask(bits);
        if (!mask) return null;
        return { network, mask };
      }

      function dottedHex(hex) {
        return hex
          .match(/.{1,4}/g)
          ?.join(".")
          .toLowerCase();
      }

      function renderWlcInputs() {
        wlcListEl.innerHTML = "";
        const label = document.createElement("label");
        label.className = "block";
        label.innerHTML = `
          <span class="text-sm font-semibold">WLC IPv4</span>
          <input
            class="sketch-input mt-2 w-full px-3 py-2"
            data-wlc
            placeholder="10.1.11.31"
          />
        `;
        wlcListEl.appendChild(label);
      }

      function getWlcIps() {
        const fields = [...document.querySelectorAll("[data-wlc]")];
        return fields.map((field) => field.value.trim()).filter(Boolean);
      }

      function normalizeHex(raw) {
        return raw
          .replace(/option\\s+43\\s+hex/i, "")
          .replace(/[^a-fA-F0-9]/g, "")
          .toLowerCase();
      }

      function hexToIp(hex) {
        if (hex.length !== 8) return "";
        const octets = hex.match(/.{1,2}/g) || [];
        if (octets.length !== 4) return "";
        return octets.map((oct) => parseInt(oct, 16)).join(".");
      }

      function applyReverseDecode() {
        const raw = inputs.reverseHex.value.trim();
        if (!raw) return;

        const normalized = normalizeHex(raw);
        if (normalized.length < 4) return;

        const type = normalized.slice(0, 2);
        if (type === "f1") {
          modeEl.value = "F1";
        } else if (type === "f3") {
          modeEl.value = "F3";
        } else {
          return;
        }

        const lengthHex = normalized.slice(2, 4);
        const lengthBytes = parseInt(lengthHex, 16);
        if (Number.isNaN(lengthBytes) || lengthBytes < 4) return;

        let ipHex = "";
        let modeHex = "";
        if (modeEl.value === "F1") {
          ipHex = normalized.slice(4, 4 + lengthBytes * 2);
        } else {
          ipHex = normalized.slice(4, 4 + (lengthBytes - 1) * 2);
          modeHex = normalized.slice(
            4 + (lengthBytes - 1) * 2,
            4 + lengthBytes * 2
          );
        }

        const ip = hexToIp(ipHex.slice(0, 8));
        const wlcField = document.querySelector("[data-wlc]");
        if (wlcField && ip) {
          wlcField.value = ip;
        }

        if (modeEl.value === "F3") {
          if (modeHex === "01" || modeHex === "02") {
            apModeEl.value = modeHex;
          } else {
            apModeEl.value = "";
          }
        } else {
          apModeEl.value = "";
        }

        updateOutputs();
      }

      function buildHex() {
        const mode = modeEl.value;
        const wlcIps = getWlcIps();
        const warnings = [];

        if (wlcIps.length === 0) {
          warnings.push("Add at least one WLC IP address.");
        }

        const invalidIps = wlcIps.filter((ip) => !isValidIp(ip));
        if (invalidIps.length) {
          warnings.push(`Invalid IP(s): ${invalidIps.join(", ")}`);
        }

        if (mode === "F3" && !apModeEl.value) {
          warnings.push("F3 mode requires an AP mode byte (Meraki or Catalyst).");
        }

        if (wlcIps.length === 0 || invalidIps.length) {
          return { hex: "", warnings };
        }

        if (mode === "F3" && !apModeEl.value) {
          return { hex: "", warnings };
        }

        const ipHex = wlcIps.map(ipToHex).join("");
        const length = mode === "F3" ? wlcIps.length * 4 + 1 : wlcIps.length * 4;
        const lengthHex = length.toString(16).padStart(2, "0");

        const hex =
          mode === "F1"
            ? `f1${lengthHex}${ipHex}`
            : `f3${lengthHex}${ipHex}${apModeEl.value}`;

        return { hex, warnings };
      }

      function buildBreakdown() {
        const { hex, warnings } = buildHex();
        hexBreakdownEl.innerHTML = "";
        hexWarningsEl.innerHTML = "";

        if (!hex) return;

        const bytes = hex.match(/.{1,2}/g) || [];
        const mode = modeEl.value;
        const wlcIps = getWlcIps().filter(isValidIp);
        const apMode = apModeEl.value;

        const breakdown = [];
        breakdown.push({ label: mode, tip: `Option type ${mode}` });
        breakdown.push({ label: bytes[1], tip: "Length byte" });

        let byteIndex = 2;
        wlcIps.forEach((ip, idx) => {
          const octets = ip.split(".");
          octets.forEach((oct, octIdx) => {
            breakdown.push({
              label: bytes[byteIndex],
              tip: `WLC ${idx + 1} octet ${octIdx + 1}: ${oct}`,
            });
            byteIndex += 1;
          });
        });

        if (mode === "F3") {
          breakdown.push({
            label: apMode || "??",
            tip: apMode
              ? `AP mode ${apMode === "01" ? "Meraki" : "Catalyst"}`
              : "Missing AP mode",
          });
        }

        breakdown.forEach((item) => {
          const pill = document.createElement("div");
          pill.className = `byte-pill tooltip ${
            item.label === "??" ? "warning" : ""
          }`;
          pill.dataset.tip = item.tip;
          pill.textContent = item.label.toLowerCase();
          hexBreakdownEl.appendChild(pill);
        });

        if (warnings.length) {
          hexWarningsEl.innerHTML = warnings
            .map((w) => `<div class="warning px-3 py-2 rounded-lg">${w}</div>`)
            .join("");
        }
      }

      function buildIosConfig(hex) {
        const cidr = inputs.cidr.value.trim();
        let netValue = "";
        let maskValue = "";
        const parsed = parseCidr(cidr);
        if (parsed) {
          netValue = parsed.network;
          maskValue = parsed.mask;
        }

        const lines = [];
        const poolName = inputs.poolName.value.trim() || "WIFI_APS";
        lines.push(`ip dhcp pool ${poolName}`);
        if (netValue && maskValue) {
          lines.push(` network ${netValue} ${maskValue}`);
        }
        if (inputs.gateway.value.trim()) {
          lines.push(` default-router ${inputs.gateway.value.trim()}`);
        }
        if (inputs.domain.value.trim()) {
          lines.push(` domain-name ${inputs.domain.value.trim()}`);
        }
        if (inputs.dns.value.trim()) {
          const dnsServers = inputs.dns.value
            .split(",")
            .map((s) => s.trim())
            .filter(Boolean);
          if (dnsServers.length) {
            lines.push(` dns-server ${dnsServers.join(" ")}`);
          }
        }
        if (hex) {
          lines.push(` option 43 hex ${hex}`);
        }

        const leaseParts = [
          inputs.leaseDays.value,
          inputs.leaseHours.value,
          inputs.leaseMinutes.value,
        ].map((v) => v.trim());

        if (leaseParts.some((v) => v !== "")) {
          const lease = leaseParts.map((v) => (v === "" ? "0" : v));
          lines.push(` lease ${lease.join(" ")}`);
        }

        return lines.join("\n");
      }

      function updateOutputs() {
        const { hex, warnings } = buildHex();
        const plain = hex ? `option 43 hex ${hex}` : "";
        hexPlainEl.textContent = plain;
        hexDottedEl.textContent = hex ? `option 43 hex ${dottedHex(hex)}` : "";
        iosConfigEl.textContent = buildIosConfig(hex);
        buildBreakdown();
        apModeEl.disabled = modeEl.value === "F1";
        if (!warnings.length) {
          hexWarningsEl.innerHTML = "";
        }
      }

      function attachListeners() {
        const allInputs = [
          modeEl,
          apModeEl,
          ...Object.values(inputs),
        ];
        allInputs.forEach((input) => {
          input.addEventListener("input", updateOutputs);
          input.addEventListener("change", updateOutputs);
        });

      }

      function attachWlcListeners() {
        const wlcInputs = [...document.querySelectorAll("[data-wlc]")];
        wlcInputs.forEach((input) => {
          input.addEventListener("input", updateOutputs);
        });
      }

      function handleCopyButtons() {
        document.querySelectorAll("[data-copy]").forEach((button) => {
          button.addEventListener("click", async () => {
            const targetId = button.getAttribute("data-copy");
            const target = document.getElementById(targetId);
            if (!target) return;
            const text = target.textContent || "";
            if (!text) return;
            try {
              await navigator.clipboard.writeText(text);
              button.textContent = "Copied!";
              setTimeout(() => {
                button.textContent = "Copy";
              }, 1200);
            } catch (err) {
              console.error(err);
            }
          });
        });
      }

      renderWlcInputs();
      attachListeners();
      attachWlcListeners();
      handleCopyButtons();
      inputs.reverseHex.addEventListener("change", applyReverseDecode);
      inputs.reverseHex.addEventListener("blur", applyReverseDecode);
      inputs.reverseHex.addEventListener("keydown", (event) => {
        if (event.key === "Enter") {
          applyReverseDecode();
        }
      });
      updateOutputs();
    </script>
  </body>
</html>
